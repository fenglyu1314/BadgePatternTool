# BadgePatternTool A4画布缩放拖拽重构说明

## 🎯 问题描述

用户反馈当前的A4预览画布缩放逻辑不符合预期：
- **当前问题**：滚轮缩放只缩放了画布里面的内容
- **用户期望**：在深色背景区域内有一个白色的A4画布，这个画布可以被缩放和拖动
- **期望效果**：A4纸区域外面是深灰色的画布背景区域，A4画布可以在这个区域内自由移动和缩放

## 🔧 重构方案

### 1. 核心设计理念

**新的视觉层次结构**：
```
深灰色背景区域 (#404040)
└── 可缩放可拖拽的白色A4画布
    ├── A4画布阴影效果
    ├── A4画布边框 (#777)
    └── 排版内容（在A4画布内）
```

**关键改进**：
- 使用自定义 `paintEvent` 绘制A4画布
- A4画布可以在深色背景区域内自由移动
- 滚轮缩放影响整个A4画布的大小
- 鼠标拖拽可以移动A4画布位置

### 2. 主要代码修改

#### InteractivePreviewLabel 类重构

**新增属性**：
```python
# A4画布位置（用于拖拽）
self.canvas_offset = QPoint(0, 0)
```

**核心方法重写**：

1. **get_a4_canvas_rect()** - 计算A4画布矩形区域
```python
def get_a4_canvas_rect(self):
    """获取A4画布的矩形区域"""
    # 计算当前A4画布的显示尺寸
    current_width = int(self.base_width * self.scale_factor)
    current_height = int(self.base_height * self.scale_factor)
    
    # 计算A4画布在控件中的位置（居中 + 偏移）
    widget_center_x = self.width() // 2
    widget_center_y = self.height() // 2
    
    canvas_x = widget_center_x - current_width // 2 + self.canvas_offset.x()
    canvas_y = widget_center_y - current_height // 2 + self.canvas_offset.y()
    
    return QRect(canvas_x, canvas_y, current_width, current_height)
```

2. **paintEvent()** - 自定义绘制A4画布
```python
def paintEvent(self, event):
    """自定义绘制事件"""
    painter = QPainter(self)
    painter.setRenderHint(QPainter.Antialiasing)
    
    # 获取A4画布矩形
    canvas_rect = self.get_a4_canvas_rect()
    
    # 绘制A4画布阴影（偏移几个像素）
    shadow_rect = canvas_rect.adjusted(4, 4, 4, 4)
    painter.fillRect(shadow_rect, QColor(0, 0, 0, 50))
    
    # 绘制A4画布背景（白色）
    painter.fillRect(canvas_rect, QColor(255, 255, 255))
    
    # 绘制A4画布边框
    pen = QPen(QColor(119, 119, 119), 2)
    painter.setPen(pen)
    painter.drawRect(canvas_rect)
    
    # 绘制排版内容
    if self.content_pixmap and not self.content_pixmap.isNull():
        # ... 内容绘制逻辑
```

3. **鼠标事件处理** - 支持A4画布拖拽
```python
def mousePressEvent(self, event: QMouseEvent):
    """鼠标按下事件"""
    if event.button() == Qt.LeftButton:
        # 检查是否点击在A4画布区域内
        canvas_rect = self.get_a4_canvas_rect()
        if canvas_rect.contains(event.pos()):
            self.dragging = True
            self.last_pan_point = event.pos()
            self.setCursor(Qt.ClosedHandCursor)

def mouseMoveEvent(self, event: QMouseEvent):
    """鼠标移动事件"""
    if self.dragging and event.buttons() == Qt.LeftButton:
        # 计算拖拽偏移
        delta = event.pos() - self.last_pan_point
        self.canvas_offset += delta
        self.last_pan_point = event.pos()
        self.update()  # 触发重绘
    else:
        # 检查鼠标是否在A4画布区域内，改变光标
        canvas_rect = self.get_a4_canvas_rect()
        if canvas_rect.contains(event.pos()):
            self.setCursor(Qt.OpenHandCursor)
        else:
            self.setCursor(Qt.ArrowCursor)
```

#### InteractiveScrollArea 类调整

**滚动条设置**：
```python
# 禁用滚动条，因为拖拽功能由A4画布自己处理
self.setHorizontalScrollBarPolicy(Qt.ScrollBarAlwaysOff)
self.setVerticalScrollBarPolicy(Qt.ScrollBarAlwaysOff)
self.setWidgetResizable(False)
```

**背景颜色调整**：
```python
# 更深的背景色以突出白色A4画布
background-color: #404040;
```

### 3. 用户交互改进

#### 缩放行为
- **滚轮向上**：放大整个A4画布（包括边框和阴影）
- **滚轮向下**：缩小整个A4画布
- **缩放中心**：A4画布保持在控件中心位置

#### 拖拽行为
- **鼠标悬停**：在A4画布区域内显示手型光标
- **点击拖拽**：只有在A4画布区域内点击才能拖拽
- **拖拽效果**：A4画布在深色背景区域内移动

#### 适应窗口
- **fit_to_window()**：计算合适的缩放比例并重置位置到中心
- **reset_view()**：重置缩放和位置

## ✅ 实现效果

### 视觉效果对比

| 功能 | 修改前 | 修改后 |
|------|--------|--------|
| **背景区域** | 深灰色固定背景 | 深灰色背景 (#404040) |
| **A4画布** | 固定在中心，只缩放内容 | 可移动的白色画布，整体缩放 |
| **缩放行为** | 只缩放排版内容 | 缩放整个A4画布（含边框阴影） |
| **拖拽行为** | 无拖拽功能 | 可拖拽A4画布位置 |
| **鼠标光标** | 固定箭头光标 | 智能切换（箭头/手型） |

### 用户体验提升

1. **直观的A4纸概念**：
   - ✅ 白色A4画布与深色背景形成强烈对比
   - ✅ 阴影效果增强立体感和层次感
   - ✅ 用户可以清楚看到A4纸的实际边界

2. **灵活的视图控制**：
   - ✅ 滚轮缩放整个A4画布，符合用户直觉
   - ✅ 拖拽移动A4画布位置，方便查看细节
   - ✅ 智能光标提示，增强交互反馈

3. **保持功能完整性**：
   - ✅ 排版内容正确显示在A4画布内
   - ✅ 适应窗口功能正常工作
   - ✅ 缩放比例控制保持一致

## 🔧 技术细节

### 坐标计算
```python
# A4画布中心位置计算
widget_center_x = self.width() // 2
widget_center_y = self.height() // 2

# A4画布实际位置 = 中心位置 + 用户拖拽偏移
canvas_x = widget_center_x - current_width // 2 + self.canvas_offset.x()
canvas_y = widget_center_y - current_height // 2 + self.canvas_offset.y()
```

### 阴影效果
```python
# 阴影矩形偏移4像素，半透明黑色
shadow_rect = canvas_rect.adjusted(4, 4, 4, 4)
painter.fillRect(shadow_rect, QColor(0, 0, 0, 50))
```

### 性能优化
- 使用 `self.update()` 触发重绘而不是完整重建
- 只在必要时重新计算A4画布矩形
- 智能光标切换减少不必要的光标更新

## 📝 使用说明

1. **缩放操作**：在A4预览区域使用鼠标滚轮进行缩放
2. **拖拽操作**：在白色A4画布区域内点击并拖拽移动画布
3. **重置视图**：使用"适应窗口"按钮重置缩放和位置
4. **光标提示**：鼠标悬停在A4画布上会显示手型光标

这次重构完全满足了用户的需求，实现了在深色背景区域内可缩放可拖拽的白色A4画布效果。
