# BadgePatternTool ä»£ç æ¶æ„æ–‡æ¡£

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

BadgePatternTool æ˜¯ä¸€ä¸ªåŸºäº PySide6 çš„æ¡Œé¢åº”ç”¨ç¨‹åºï¼Œç”¨äºç”Ÿæˆå¾½ç« åˆ¶ä½œçš„å›¾æ¡ˆæ’ç‰ˆã€‚ç¨‹åºå°†ç”¨æˆ·æä¾›çš„å›¾ç‰‡è£å‰ªæˆæŒ‡å®šç›´å¾„çš„åœ†å½¢ï¼Œå¹¶åœ¨A4çº¸ä¸Šè¿›è¡Œæ™ºèƒ½æ’ç‰ˆï¼Œæ”¯æŒå¯¼å‡ºå’Œæ‰“å°åŠŸèƒ½ã€‚

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½
- å›¾ç‰‡å¯¼å…¥å’Œåœ†å½¢è£å‰ª
- äº¤äº’å¼å›¾ç‰‡ç¼–è¾‘ï¼ˆç¼©æ”¾ã€ç§»åŠ¨ã€æ—‹è½¬ï¼‰
- æ™ºèƒ½A4æ’ç‰ˆï¼ˆç½‘æ ¼æ¨¡å¼/ç´§å‡‘æ¨¡å¼ï¼‰
- å¤šé¡µé¢æ’ç‰ˆæ”¯æŒ
- é«˜è´¨é‡å¯¼å‡ºï¼ˆPNG/JPG/PDFï¼‰
- ç›´æ¥æ‰“å°åŠŸèƒ½

## ğŸ—ï¸ é¡¹ç›®æ¶æ„

```
BadgePatternTool/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.py                 # ç¨‹åºå…¥å£
â”‚   â”œâ”€â”€ common/                 # å…¬å…±æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ constants.py        # å…¨å±€å¸¸é‡å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ error_handler.py    # é”™è¯¯å¤„ç†å’Œæ—¥å¿—
â”‚   â”‚   â”œâ”€â”€ path_utils.py       # è·¯å¾„å·¥å…·å‡½æ•°
â”‚   â”‚   â””â”€â”€ imports.py          # ç»Ÿä¸€å¯¼å…¥ç®¡ç†
â”‚   â”œâ”€â”€ core/                   # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ image_processor.py  # å›¾ç‰‡å¤„ç†å¼•æ“
â”‚   â”‚   â”œâ”€â”€ layout_engine.py    # æ’ç‰ˆå¸ƒå±€å¼•æ“
â”‚   â”‚   â””â”€â”€ export_manager.py   # å¯¼å‡ºç®¡ç†å™¨
â”‚   â”œâ”€â”€ ui/                     # ç”¨æˆ·ç•Œé¢
â”‚   â”‚   â”œâ”€â”€ main_window.py      # ä¸»çª—å£
â”‚   â”‚   â”œâ”€â”€ panels/             # UIé¢æ¿ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ interactive_image_editor.py  # äº¤äº’å¼ç¼–è¾‘å™¨
â”‚   â”‚   â””â”€â”€ multi_page_preview_widget.py # å¤šé¡µé¢„è§ˆç»„ä»¶
â”‚   â””â”€â”€ utils/                  # å·¥å…·æ¨¡å—
â”‚       â”œâ”€â”€ config.py           # é…ç½®ç®¡ç†
â”‚       â””â”€â”€ file_handler.py     # æ–‡ä»¶å¤„ç†
â”œâ”€â”€ tests/                      # æµ‹è¯•ç”¨ä¾‹
â”œâ”€â”€ scripts/                    # æ„å»ºå’Œå·¥å…·è„šæœ¬
â””â”€â”€ docs/                       # æ–‡æ¡£
```

## ğŸ”„ ç¨‹åºè¿è¡Œæµç¨‹

### 1. å¯åŠ¨æµç¨‹
```python
main.py â†’ MainWindow.__init__() â†’ åˆå§‹åŒ–å„ä¸ªç»„ä»¶ â†’ æ˜¾ç¤ºç•Œé¢
```

### 2. å›¾ç‰‡å¤„ç†æµç¨‹
```
ç”¨æˆ·å¯¼å…¥å›¾ç‰‡ â†’ FileHandleréªŒè¯ â†’ ImageProcessorå¤„ç† â†’ 
äº¤äº’å¼ç¼–è¾‘ â†’ å‚æ•°åº”ç”¨ â†’ æ’ç‰ˆé¢„è§ˆæ›´æ–°
```

### 3. æ’ç‰ˆæµç¨‹
```
è·å–å›¾ç‰‡åˆ—è¡¨ â†’ LayoutEngineè®¡ç®—å¸ƒå±€ â†’ ç”Ÿæˆé¢„è§ˆ â†’ 
å¤šé¡µé¢å¤„ç† â†’ æ˜¾ç¤ºç»“æœ
```

### 4. å¯¼å‡ºæµç¨‹
```
æ”¶é›†æ‰€æœ‰å‚æ•° â†’ ExportManagerå¤„ç† â†’ ç”Ÿæˆé«˜åˆ†è¾¨ç‡å›¾åƒ â†’ 
ä¿å­˜æ–‡ä»¶/å‘é€æ‰“å°æœº
```

## ğŸ“¦ æ ¸å¿ƒæ¨¡å—è¯¦è§£

### ğŸ¨ å›¾ç‰‡å¤„ç†æ¨¡å— (image_processor.py)

#### æ ¸å¿ƒç±»ï¼šImageProcessor
è´Ÿè´£æ‰€æœ‰å›¾ç‰‡ç›¸å…³çš„å¤„ç†æ“ä½œï¼ŒåŒ…æ‹¬åŠ è½½ã€ç¼©æ”¾ã€è£å‰ªã€æ—‹è½¬ç­‰ã€‚

**ä¸»è¦æ–¹æ³•ï¼š**

1. **load_image(file_path)**
   ```python
   # åŠ è½½å›¾ç‰‡å¹¶è¿›è¡ŒåŸºç¡€éªŒè¯
   # æ”¯æŒæ ¼å¼ï¼šPNG, JPG, JPEG, BMP, GIF
   # è¿”å›PIL.Imageå¯¹è±¡
   ```

2. **create_circular_crop(params)**
   ```python
   # æ ¸å¿ƒç®—æ³•ï¼šåœ†å½¢è£å‰ª
   # 1. æ ¹æ®scaleå‚æ•°ç¼©æ”¾å›¾ç‰‡
   # 2. åº”ç”¨offset_x, offset_yåç§»
   # 3. åº”ç”¨rotationæ—‹è½¬
   # 4. åˆ›å»ºåœ†å½¢é®ç½©è¿›è¡Œè£å‰ª
   # 5. è¿”å›é€æ˜èƒŒæ™¯çš„åœ†å½¢å›¾ç‰‡
   ```

**ç®—æ³•åŸç†ï¼š**
- **ç¼©æ”¾ç®—æ³•**ï¼šä½¿ç”¨PILçš„é«˜è´¨é‡é‡é‡‡æ ·ï¼ˆLANCZOSï¼‰
- **åœ†å½¢è£å‰ª**ï¼šåˆ›å»ºåœ†å½¢Alphaé®ç½©ï¼Œåº”ç”¨åˆ°å›¾ç‰‡ä¸Š
- **åæ ‡è½¬æ¢**ï¼šåƒç´ åæ ‡ä¸æ¯«ç±³å•ä½çš„ç²¾ç¡®è½¬æ¢

#### æ ¸å¿ƒç±»ï¼šCircleEditor
æä¾›å›¾ç‰‡ç¼–è¾‘çš„å‚æ•°ç®¡ç†å’Œæœ€ä¼˜åŒ–è®¡ç®—ã€‚

**å…³é”®ç®—æ³•ï¼š**
```python
def get_optimal_scale(self, image_path):
    """
    è®¡ç®—æœ€ä½³ç¼©æ”¾æ¯”ä¾‹ç®—æ³•ï¼š
    1. è·å–å›¾ç‰‡åŸå§‹å°ºå¯¸
    2. è®¡ç®—å›¾ç‰‡æœ€å°è¾¹ä¸ç›®æ ‡åœ†å½¢ç›´å¾„çš„æ¯”ä¾‹
    3. ç¡®ä¿å›¾ç‰‡èƒ½å®Œå…¨è¦†ç›–åœ†å½¢åŒºåŸŸ
    4. è¿”å›æœ€ä½³ç¼©æ”¾å€¼
    """
    image = Image.open(image_path)
    min_dimension = min(image.size)
    target_diameter = app_config.badge_diameter_px
    optimal_scale = target_diameter / min_dimension
    return max(optimal_scale, 0.1)  # æœ€å°ç¼©æ”¾é™åˆ¶
```

### ğŸ“ æ’ç‰ˆå¼•æ“ (layout_engine.py)

#### æ ¸å¿ƒç±»ï¼šLayoutEngine
è´Ÿè´£A4çº¸å¼ ä¸Šçš„æ™ºèƒ½æ’ç‰ˆè®¡ç®—å’Œé¢„è§ˆç”Ÿæˆã€‚

**ä¸»è¦ç®—æ³•ï¼š**

1. **ç½‘æ ¼å¸ƒå±€ç®—æ³• (calculate_grid_layout)**
   ```python
   # è§„åˆ™ç½‘æ ¼æ’åˆ—
   # 1. è®¡ç®—A4å¯ç”¨åŒºåŸŸï¼ˆå‡å»é¡µè¾¹è·ï¼‰
   # 2. æ ¹æ®åœ†å½¢ç›´å¾„å’Œé—´è·è®¡ç®—è¡Œåˆ—æ•°
   # 3. å‡åŒ€åˆ†å¸ƒåœ†å½¢ä½ç½®
   # 4. è¿”å›ä½ç½®åæ ‡åˆ—è¡¨
   ```

2. **ç´§å‡‘å¸ƒå±€ç®—æ³• (calculate_compact_layout)**
   ```python
   # å…­è¾¹å½¢ç´§å¯†æ’åˆ—
   # 1. ç¬¬ä¸€è¡Œï¼šæ­£å¸¸é—´è·æ’åˆ—
   # 2. ç¬¬äºŒè¡Œï¼šæ°´å¹³åç§»åŠä¸ªé—´è·ï¼Œå‚ç›´ç´§å¯†æ’åˆ—
   # 3. äº¤æ›¿æ’åˆ—ï¼Œæœ€å¤§åŒ–ç©ºé—´åˆ©ç”¨ç‡
   # 4. ç‰¹æ®Šå¤„ç†ï¼š3åˆ—å¸ƒå±€ä¼˜åŒ–ï¼ˆ4-3-4æ’åˆ—ï¼‰
   ```

**åæ ‡è®¡ç®—æ ¸å¿ƒï¼š**
```python
def calculate_position(row, col, layout_type):
    """
    ä½ç½®è®¡ç®—ç®—æ³•ï¼š
    - ç½‘æ ¼æ¨¡å¼ï¼šx = margin + col * (diameter + spacing)
    - ç´§å‡‘æ¨¡å¼ï¼šè€ƒè™‘è¡Œåç§»çš„å…­è¾¹å½¢æ’åˆ—
    - åæ ‡ç³»ï¼šå·¦ä¸Šè§’ä¸ºåŸç‚¹ï¼Œå‘å³å‘ä¸‹ä¸ºæ­£æ–¹å‘
    """
```

3. **å¤šé¡µé¢å¸ƒå±€ (calculate_multi_page_layout)**
   ```python
   # å¤šé¡µé¢åˆ†é¡µç®—æ³•
   # 1. è®¡ç®—å•é¡µæœ€å¤§å®¹é‡
   # 2. æŒ‰å®¹é‡åˆ†å‰²å›¾ç‰‡åˆ—è¡¨
   # 3. ä¸ºæ¯é¡µç”Ÿæˆç‹¬ç«‹å¸ƒå±€
   # 4. è¿”å›å¤šé¡µé¢å¸ƒå±€ä¿¡æ¯
   ```

### ğŸ–¼ï¸ äº¤äº’å¼ç¼–è¾‘å™¨ (interactive_image_editor.py)

#### æ ¸å¿ƒç±»ï¼šInteractiveImageEditor
æä¾›å®æ—¶çš„å›¾ç‰‡ç¼–è¾‘é¢„è§ˆå’Œäº¤äº’åŠŸèƒ½ã€‚

**å…³é”®ç‰¹æ€§ï¼š**

1. **å®æ—¶é¢„è§ˆæ¸²æŸ“**
   ```python
   def paintEvent(self, event):
       """
       æ¸²æŸ“æµç¨‹ï¼š
       1. ç»˜åˆ¶ç¼©æ”¾åçš„å›¾ç‰‡
       2. åº”ç”¨åœ†å½¢é®ç½©æ•ˆæœ
       3. ç»˜åˆ¶å®‰å…¨åŒºåŸŸæŒ‡ç¤º
       4. ç»˜åˆ¶ä¸­å¿ƒåå­—çº¿
       5. åº”ç”¨é€æ˜åº¦è®¾ç½®
       """
   ```

2. **é¼ æ ‡äº¤äº’å¤„ç†**
   ```python
   # æ‹–æ‹½ç§»åŠ¨ï¼šè®°å½•é¼ æ ‡ä½ç½®å·®å€¼ï¼Œæ›´æ–°offsetå‚æ•°
   # æ»šè½®ç¼©æ”¾ï¼šè®¡ç®—ç¼©æ”¾å› å­ï¼Œåº”ç”¨é˜²æŠ–æœºåˆ¶
   # å®æ—¶åé¦ˆï¼šå‚æ•°å˜åŒ–ç«‹å³è§¦å‘é‡ç»˜
   ```

3. **æ€§èƒ½ä¼˜åŒ–æœºåˆ¶**
   ```python
   # å›¾ç‰‡ç¼“å­˜ï¼šé¿å…é‡å¤åŠ è½½å’Œå¤„ç†
   # é˜²æŠ–å®šæ—¶å™¨ï¼šå‡å°‘é«˜é¢‘æ“ä½œçš„æ€§èƒ½å½±å“
   # åˆ†è¾¨ç‡é€‚é…ï¼šç¼–è¾‘æ—¶ä½¿ç”¨ä½åˆ†è¾¨ç‡ï¼Œå¯¼å‡ºæ—¶ä½¿ç”¨åŸåˆ†è¾¨ç‡
   ```

### ğŸ“„ å¤šé¡µé¢é¢„è§ˆ (multi_page_preview_widget.py)

#### æ ¸å¿ƒç±»ï¼šMultiPagePreviewWidget
å¤„ç†å¤šé¡µé¢A4é¢„è§ˆçš„æ˜¾ç¤ºå’Œäº¤äº’ã€‚

**å¸ƒå±€ç®—æ³•ï¼š**
```python
def arrange_pages_in_grid(self, page_count):
    """
    é¡µé¢ç½‘æ ¼æ’åˆ—ç®—æ³•ï¼š
    - 1é¡µï¼š1x1
    - 2-4é¡µï¼š2x2ç½‘æ ¼
    - 5-6é¡µï¼š2x3ç½‘æ ¼
    - 7-9é¡µï¼š3x3ç½‘æ ¼
    ä¼˜åŒ–æ˜¾ç¤ºå¯†åº¦å’Œå¯è¯»æ€§
    """
```

**ç¼©æ”¾å’Œå¹³ç§»ï¼š**
```python
# ç»Ÿä¸€ç¼©æ”¾ï¼šæ‰€æœ‰é¡µé¢åŒæ­¥ç¼©æ”¾
# ç”»å¸ƒæ‹–æ‹½ï¼šæ•´ä½“ç§»åŠ¨æ‰€æœ‰é¡µé¢
# è¾¹ç•Œæ£€æµ‹ï¼šé˜²æ­¢æ‹–æ‹½è¶…å‡ºåˆç†èŒƒå›´
```

## ğŸ”§ é…ç½®ç®¡ç†ç³»ç»Ÿ

### AppConfigç±» (config.py)
é›†ä¸­ç®¡ç†æ‰€æœ‰åº”ç”¨é…ç½®ï¼Œæ”¯æŒåŠ¨æ€æ›´æ–°å’Œç›‘å¬ã€‚

**é…ç½®é¡¹åˆ†ç±»ï¼š**
```python
# å¾½ç« å°ºå¯¸é…ç½®
badge_size_mm: å¾½ç« ç›´å¾„ï¼ˆä¸å«å‡ºè¡€ï¼‰
bleed_size_mm: å‡ºè¡€åŠå¾„
badge_diameter_mm: æ€»ç›´å¾„ï¼ˆå¾½ç« +å‡ºè¡€*2ï¼‰

# å¸ƒå±€é…ç½®
spacing_mm: åœ†å½¢é—´è·
margin_mm: é¡µé¢è¾¹è·
layout_mode: å¸ƒå±€æ¨¡å¼ï¼ˆgrid/compactï¼‰

# æ˜¾ç¤ºé…ç½®
outside_opacity: åœ†å¤–åŒºåŸŸé€æ˜åº¦
bleed_opacity: å‡ºè¡€åŒºåŸŸé€æ˜åº¦
```

**ç›‘å¬æœºåˆ¶ï¼š**
```python
def add_listener(self, callback):
    """
    é…ç½®å˜åŒ–ç›‘å¬å™¨
    å½“é…ç½®é¡¹æ”¹å˜æ—¶ï¼Œè‡ªåŠ¨é€šçŸ¥æ‰€æœ‰ç›‘å¬å™¨
    ç”¨äºå®æ—¶æ›´æ–°UIå’Œé‡æ–°è®¡ç®—å¸ƒå±€
    """
```

## ğŸ¯ å…³é”®ç®—æ³•è¯¦è§£

### 1. åæ ‡ç³»è½¬æ¢ç®—æ³•

ç¨‹åºä¸­æ¶‰åŠå¤šä¸ªåæ ‡ç³»çš„è½¬æ¢ï¼š

```python
# æ¯«ç±³ â†’ åƒç´ ï¼ˆ300 DPIï¼‰
def mm_to_px(mm_value):
    return int(mm_value * 300 / 25.4)

# åƒç´  â†’ æ¯«ç±³
def px_to_mm(px_value):
    return px_value * 25.4 / 300

# ç¼–è¾‘å™¨åæ ‡ â†’ å®é™…åæ ‡
def editor_to_actual(editor_coord, scale_ratio):
    return editor_coord / scale_ratio
```

### 2. åœ†å½¢è£å‰ªç®—æ³•

```python
def create_circular_mask(size, center, radius):
    """
    åˆ›å»ºåœ†å½¢é®ç½©ï¼š
    1. åˆ›å»ºä¸å›¾ç‰‡åŒå°ºå¯¸çš„é®ç½©
    2. ä½¿ç”¨è·ç¦»å…¬å¼åˆ¤æ–­æ¯ä¸ªåƒç´ æ˜¯å¦åœ¨åœ†å†…
    3. åœ†å†…åƒç´ è®¾ä¸º255ï¼ˆä¸é€æ˜ï¼‰ï¼Œåœ†å¤–è®¾ä¸º0ï¼ˆé€æ˜ï¼‰
    4. åº”ç”¨æŠ—é”¯é½¿å¤„ç†ï¼Œè¾¹ç¼˜å¹³æ»‘
    """
    y, x = np.ogrid[:size[1], :size[0]]
    mask = (x - center[0])**2 + (y - center[1])**2 <= radius**2
    return mask.astype(np.uint8) * 255
```

### 3. å¸ƒå±€ä¼˜åŒ–ç®—æ³•

```python
def optimize_compact_layout(available_width, circle_diameter, spacing):
    """
    ç´§å‡‘å¸ƒå±€ä¼˜åŒ–ï¼š
    1. è®¡ç®—ç†è®ºæœ€å¤§åˆ—æ•°
    2. è€ƒè™‘å…­è¾¹å½¢æ’åˆ—çš„ç©ºé—´æ•ˆç‡
    3. ç‰¹æ®Šä¼˜åŒ–ï¼šå½“å¯æ”¾ç½®3åˆ—æ—¶ï¼Œä½¿ç”¨4-3-4äº¤æ›¿æ’åˆ—
    4. æœ€å¤§åŒ–å•é¡µåœ†å½¢æ•°é‡
    """
    max_cols = int(available_width / (circle_diameter + spacing))
    if max_cols == 3:
        # ç‰¹æ®Šä¼˜åŒ–ï¼š3åˆ—å˜4-3-4æ’åˆ—
        return optimize_alternating_layout()
    return standard_compact_layout(max_cols)
```

## ğŸ”„ æ•°æ®æµå‘

### 1. å›¾ç‰‡æ•°æ®æµ
```
æ–‡ä»¶é€‰æ‹© â†’ FileHandler.validate() â†’ ImageItemåˆ›å»º â†’ 
ImageProcessor.load() â†’ äº¤äº’å¼ç¼–è¾‘ â†’ å‚æ•°æ›´æ–° â†’ 
LayoutEngine.arrange() â†’ é¢„è§ˆç”Ÿæˆ â†’ ExportManager.export()
```

### 2. é…ç½®æ•°æ®æµ
```
ç”¨æˆ·è¾“å…¥ â†’ UIæ§ä»¶äº‹ä»¶ â†’ AppConfigæ›´æ–° â†’ 
ç›‘å¬å™¨é€šçŸ¥ â†’ ç›¸å…³ç»„ä»¶æ›´æ–° â†’ ç•Œé¢åˆ·æ–°
```

### 3. é¢„è§ˆæ•°æ®æµ
```
å›¾ç‰‡å‚æ•°å˜åŒ– â†’ å“ˆå¸Œè®¡ç®— â†’ ç¼“å­˜æ£€æŸ¥ â†’ 
å¸ƒå±€é‡è®¡ç®— â†’ é¢„è§ˆå›¾ç”Ÿæˆ â†’ ç•Œé¢æ˜¾ç¤º
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. ç¼“å­˜æœºåˆ¶
- **å›¾ç‰‡ç¼“å­˜**ï¼šé¿å…é‡å¤åŠ è½½åŸå§‹å›¾ç‰‡
- **é¢„è§ˆç¼“å­˜**ï¼šåŸºäºå‚æ•°å“ˆå¸Œçš„æ™ºèƒ½ç¼“å­˜
- **å¸ƒå±€ç¼“å­˜**ï¼šç›¸åŒå‚æ•°çš„å¸ƒå±€ç»“æœå¤ç”¨

### 2. é˜²æŠ–æœºåˆ¶
- **æ»‘å—æ“ä½œ**ï¼šå»¶è¿Ÿå¤„ç†é«˜é¢‘å˜åŒ–
- **é¼ æ ‡æ‹–æ‹½**ï¼šæ‰¹é‡æ›´æ–°å‡å°‘é‡ç»˜
- **çª—å£ç¼©æ”¾**ï¼šé¿å…è¿ç»­é‡è®¡ç®—

### 3. å¼‚æ­¥å¤„ç†
- **å›¾ç‰‡åŠ è½½**ï¼šåå°çº¿ç¨‹å¤„ç†å¤§å›¾ç‰‡
- **å¯¼å‡ºæ“ä½œ**ï¼šéé˜»å¡å¼æ–‡ä»¶å†™å…¥
- **é¢„è§ˆç”Ÿæˆ**ï¼šæ¸è¿›å¼æ¸²æŸ“

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### 1. å•å…ƒæµ‹è¯•
- æ ¸å¿ƒç®—æ³•çš„æ•°å­¦è®¡ç®—éªŒè¯
- åæ ‡è½¬æ¢çš„ç²¾åº¦æµ‹è¯•
- è¾¹ç•Œæ¡ä»¶çš„å¼‚å¸¸å¤„ç†

### 2. é›†æˆæµ‹è¯•
- å®Œæ•´å·¥ä½œæµç¨‹æµ‹è¯•
- å¤šæ¨¡å—åä½œéªŒè¯
- ç”¨æˆ·æ“ä½œåœºæ™¯æ¨¡æ‹Ÿ

### 3. æ€§èƒ½æµ‹è¯•
- å¤§é‡å›¾ç‰‡å¤„ç†æ€§èƒ½
- å†…å­˜ä½¿ç”¨ç›‘æ§
- å“åº”æ—¶é—´æµ‹é‡

## ğŸ“š å¼€å‘æŒ‡å—

### 1. æ·»åŠ æ–°åŠŸèƒ½
1. åœ¨å¯¹åº”æ¨¡å—æ·»åŠ æ ¸å¿ƒé€»è¾‘
2. æ›´æ–°UIç•Œé¢å’Œäº¤äº’
3. ä¿®æ”¹é…ç½®ç®¡ç†
4. æ·»åŠ æµ‹è¯•ç”¨ä¾‹
5. æ›´æ–°æ–‡æ¡£

### 2. è°ƒè¯•æŠ€å·§
- ä½¿ç”¨loggerè®°å½•å…³é”®æ“ä½œ
- å¯ç”¨è°ƒè¯•æ¨¡å¼æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
- åˆ©ç”¨æ–­ç‚¹è°ƒè¯•å¤æ‚ç®—æ³•
- ç›‘æ§å†…å­˜å’Œæ€§èƒ½æŒ‡æ ‡

### 3. ä»£ç è§„èŒƒ
- éµå¾ªPEP 8ç¼–ç è§„èŒƒ
- ä½¿ç”¨ç±»å‹æç¤ºå¢å¼ºå¯è¯»æ€§
- ç¼–å†™è¯¦ç»†çš„æ–‡æ¡£å­—ç¬¦ä¸²
- ä¿æŒæ¨¡å—é—´çš„ä½è€¦åˆ

## ğŸ” è¯¦ç»†æŠ€æœ¯å®ç°

### å›¾ç‰‡å¤„ç†æ ¸å¿ƒç®—æ³• (image_processor.py)

#### 1. å›¾ç‰‡åŠ è½½å’ŒéªŒè¯
```python
def load_image(self, file_path):
    """
    å›¾ç‰‡åŠ è½½æµç¨‹ï¼š
    1. æ–‡ä»¶æ ¼å¼éªŒè¯ï¼ˆæ”¯æŒPNG/JPG/JPEG/BMP/GIFï¼‰
    2. æ–‡ä»¶å¤§å°æ£€æŸ¥ï¼ˆé˜²æ­¢å†…å­˜æº¢å‡ºï¼‰
    3. å›¾ç‰‡å®Œæ•´æ€§éªŒè¯
    4. è‰²å½©æ¨¡å¼æ ‡å‡†åŒ–ï¼ˆè½¬æ¢ä¸ºRGBï¼‰
    5. EXIFæ–¹å‘ä¿¡æ¯å¤„ç†
    """
    try:
        with Image.open(file_path) as img:
            # å¤„ç†EXIFæ—‹è½¬ä¿¡æ¯
            img = ImageOps.exif_transpose(img)
            # è½¬æ¢ä¸ºRGBæ¨¡å¼ï¼ˆç»Ÿä¸€å¤„ç†ï¼‰
            if img.mode != 'RGB':
                img = img.convert('RGB')
            return img
    except Exception as e:
        logger.error(f"å›¾ç‰‡åŠ è½½å¤±è´¥: {e}")
        return None
```

#### 2. åœ†å½¢è£å‰ªç®—æ³•è¯¦è§£
```python
def create_circular_crop(self, params):
    """
    åœ†å½¢è£å‰ªçš„å®Œæ•´æµç¨‹ï¼š

    ç¬¬ä¸€æ­¥ï¼šå›¾ç‰‡é¢„å¤„ç†
    - åŠ è½½åŸå§‹å›¾ç‰‡
    - åº”ç”¨ç¼©æ”¾å˜æ¢
    - åº”ç”¨æ—‹è½¬å˜æ¢

    ç¬¬äºŒæ­¥ï¼šåæ ‡è®¡ç®—
    - è®¡ç®—å›¾ç‰‡åœ¨ç”»å¸ƒä¸Šçš„ä½ç½®
    - è€ƒè™‘ç”¨æˆ·è®¾ç½®çš„åç§»é‡
    - ç¡®å®šè£å‰ªåŒºåŸŸçš„è¾¹ç•Œ

    ç¬¬ä¸‰æ­¥ï¼šåœ†å½¢é®ç½©ç”Ÿæˆ
    - åˆ›å»ºä¸ç›®æ ‡å°ºå¯¸ç›¸åŒçš„é®ç½©
    - ä½¿ç”¨æŠ—é”¯é½¿ç®—æ³•ç»˜åˆ¶åœ†å½¢
    - å¤„ç†è¾¹ç¼˜å¹³æ»‘æ•ˆæœ

    ç¬¬å››æ­¥ï¼šå›¾ç‰‡åˆæˆ
    - å°†å¤„ç†åçš„å›¾ç‰‡æ”¾ç½®åˆ°ç›®æ ‡ä½ç½®
    - åº”ç”¨åœ†å½¢é®ç½©è¿›è¡Œè£å‰ª
    - ç”Ÿæˆé€æ˜èƒŒæ™¯çš„æœ€ç»ˆå›¾ç‰‡
    """
```

#### 3. æ€§èƒ½ä¼˜åŒ–çš„ç¼“å­˜æœºåˆ¶
```python
class ImageProcessor:
    def __init__(self):
        self._image_cache = {}  # åŸå§‹å›¾ç‰‡ç¼“å­˜
        self._processed_cache = {}  # å¤„ç†ç»“æœç¼“å­˜
        self._cache_size_limit = 50  # ç¼“å­˜å¤§å°é™åˆ¶

    def _get_cache_key(self, params):
        """
        ç”Ÿæˆç¼“å­˜é”®å€¼ï¼š
        - æ–‡ä»¶è·¯å¾„ + ä¿®æ”¹æ—¶é—´ï¼ˆæ£€æµ‹æ–‡ä»¶å˜åŒ–ï¼‰
        - æ‰€æœ‰å¤„ç†å‚æ•°çš„å“ˆå¸Œå€¼
        - ç›®æ ‡å°ºå¯¸ä¿¡æ¯
        """
        file_stat = os.stat(params.image_path)
        param_hash = hashlib.md5(
            f"{params.scale}_{params.offset_x}_{params.offset_y}_"
            f"{params.rotation}_{app_config.badge_diameter_mm}".encode()
        ).hexdigest()
        return f"{params.image_path}_{file_stat.st_mtime}_{param_hash}"
```

### æ’ç‰ˆå¼•æ“ç®—æ³•è¯¦è§£ (layout_engine.py)

#### 1. A4çº¸å¼ åæ ‡ç³»ç»Ÿ
```python
class LayoutEngine:
    # A4çº¸å¼ æ ‡å‡†å°ºå¯¸ï¼ˆæ¯«ç±³ï¼‰
    A4_WIDTH_MM = 210
    A4_HEIGHT_MM = 297

    # è½¬æ¢ä¸ºåƒç´ ï¼ˆ300 DPIï¼‰
    A4_WIDTH_PX = int(210 * 300 / 25.4)  # 2480åƒç´ 
    A4_HEIGHT_PX = int(297 * 300 / 25.4)  # 3508åƒç´ 

    def __init__(self):
        """
        åæ ‡ç³»å®šä¹‰ï¼š
        - åŸç‚¹ï¼šA4çº¸å¼ å·¦ä¸Šè§’
        - Xè½´ï¼šå‘å³ä¸ºæ­£æ–¹å‘
        - Yè½´ï¼šå‘ä¸‹ä¸ºæ­£æ–¹å‘
        - å•ä½ï¼šåƒç´ ï¼ˆ300 DPIæ ‡å‡†ï¼‰
        """
```

#### 2. ç½‘æ ¼å¸ƒå±€ç®—æ³•å®ç°
```python
def calculate_grid_layout(self, spacing_mm, margin_mm):
    """
    ç½‘æ ¼å¸ƒå±€çš„æ•°å­¦è®¡ç®—ï¼š

    å¯ç”¨å®½åº¦ = A4å®½åº¦ - 2 * é¡µè¾¹è·
    å¯ç”¨é«˜åº¦ = A4é«˜åº¦ - 2 * é¡µè¾¹è·

    åˆ—æ•°è®¡ç®—ï¼š
    cols = floor((å¯ç”¨å®½åº¦ + é—´è·) / (åœ†ç›´å¾„ + é—´è·))

    è¡Œæ•°è®¡ç®—ï¼š
    rows = floor((å¯ç”¨é«˜åº¦ + é—´è·) / (åœ†ç›´å¾„ + é—´è·))

    ä½ç½®è®¡ç®—ï¼š
    x = é¡µè¾¹è· + col * (åœ†ç›´å¾„ + é—´è·) + åœ†åŠå¾„
    y = é¡µè¾¹è· + row * (åœ†ç›´å¾„ + é—´è·) + åœ†åŠå¾„
    """
    available_width = self.a4_width_px - 2 * self.mm_to_px(margin_mm)
    available_height = self.a4_height_px - 2 * self.mm_to_px(margin_mm)

    circle_diameter_px = app_config.badge_diameter_px
    spacing_px = self.mm_to_px(spacing_mm)

    cols = int((available_width + spacing_px) / (circle_diameter_px + spacing_px))
    rows = int((available_height + spacing_px) / (circle_diameter_px + spacing_px))

    positions = []
    for row in range(rows):
        for col in range(cols):
            x = self.mm_to_px(margin_mm) + col * (circle_diameter_px + spacing_px) + circle_diameter_px // 2
            y = self.mm_to_px(margin_mm) + row * (circle_diameter_px + spacing_px) + circle_diameter_px // 2
            positions.append((x, y))

    return {
        'positions': positions,
        'max_count': len(positions),
        'rows': rows,
        'cols': cols
    }
```

#### 3. ç´§å‡‘å¸ƒå±€çš„å…­è¾¹å½¢æ’åˆ—
```python
def calculate_compact_layout(self, spacing_mm, margin_mm):
    """
    å…­è¾¹å½¢ç´§å¯†æ’åˆ—ç®—æ³•ï¼š

    åŸºæœ¬åŸç†ï¼š
    - å¥‡æ•°è¡Œï¼šæ­£å¸¸ä½ç½®æ’åˆ—
    - å¶æ•°è¡Œï¼šæ°´å¹³åç§»åŠä¸ªå•å…ƒæ ¼
    - å‚ç›´é—´è·ï¼šå‡å°‘ä¸º sqrt(3)/2 å€

    æ•°å­¦å…¬å¼ï¼š
    æ°´å¹³åç§» = (åœ†ç›´å¾„ + é—´è·) / 2
    å‚ç›´é—´è· = (åœ†ç›´å¾„ + é—´è·) * sqrt(3) / 2

    ç‰¹æ®Šä¼˜åŒ–ï¼š3åˆ—å¸ƒå±€
    - ç¬¬1è¡Œï¼š4ä¸ªåœ†å½¢
    - ç¬¬2è¡Œï¼š3ä¸ªåœ†å½¢ï¼ˆå±…ä¸­ï¼‰
    - ç¬¬3è¡Œï¼š4ä¸ªåœ†å½¢
    - å¾ªç¯æ’åˆ—ï¼Œæœ€å¤§åŒ–åˆ©ç”¨ç©ºé—´
    """
    import math

    circle_diameter_px = app_config.badge_diameter_px
    spacing_px = self.mm_to_px(spacing_mm)
    margin_px = self.mm_to_px(margin_mm)

    # è®¡ç®—å…­è¾¹å½¢æ’åˆ—çš„å‚ç›´é—´è·
    vertical_spacing = int((circle_diameter_px + spacing_px) * math.sqrt(3) / 2)
    horizontal_spacing = circle_diameter_px + spacing_px

    available_width = self.a4_width_px - 2 * margin_px
    available_height = self.a4_height_px - 2 * margin_px

    # è®¡ç®—åŸºç¡€åˆ—æ•°
    base_cols = int((available_width + spacing_px) / horizontal_spacing)

    # ç‰¹æ®Šå¤„ç†ï¼š3åˆ—ä¼˜åŒ–ä¸º4-3-4æ’åˆ—
    if base_cols == 3:
        return self._calculate_alternating_layout(spacing_mm, margin_mm)

    # æ ‡å‡†å…­è¾¹å½¢æ’åˆ—
    positions = []
    row = 0
    y = margin_px + circle_diameter_px // 2

    while y + circle_diameter_px // 2 <= self.a4_height_px - margin_px:
        is_even_row = (row % 2 == 0)
        cols_in_row = base_cols if is_even_row else max(base_cols - 1, 1)

        # è®¡ç®—è¡Œçš„èµ·å§‹Xä½ç½®
        if is_even_row:
            start_x = margin_px + circle_diameter_px // 2
        else:
            start_x = margin_px + circle_diameter_px // 2 + horizontal_spacing // 2

        # æ·»åŠ å½“å‰è¡Œçš„æ‰€æœ‰åœ†å½¢ä½ç½®
        for col in range(cols_in_row):
            x = start_x + col * horizontal_spacing
            if x + circle_diameter_px // 2 <= self.a4_width_px - margin_px:
                positions.append((x, y))

        row += 1
        y += vertical_spacing

    return {
        'positions': positions,
        'max_count': len(positions),
        'layout_type': 'compact'
    }
```

### äº¤äº’å¼ç¼–è¾‘å™¨æŠ€æœ¯å®ç°

#### 1. å®æ—¶æ¸²æŸ“ç®¡é“
```python
def paintEvent(self, event):
    """
    æ¸²æŸ“ç®¡é“çš„å®Œæ•´æµç¨‹ï¼š

    1. å‡†å¤‡é˜¶æ®µ
       - åˆ›å»ºQPainterå¯¹è±¡
       - è®¾ç½®æ¸²æŸ“è´¨é‡ï¼ˆæŠ—é”¯é½¿ï¼‰
       - è®¡ç®—ç¼–è¾‘å™¨ä¸­å¿ƒç‚¹

    2. å›¾ç‰‡æ¸²æŸ“
       - è·å–ç¼“å­˜çš„å›¾ç‰‡QPixmap
       - è®¡ç®—æ˜¾ç¤ºä½ç½®å’Œå°ºå¯¸
       - åº”ç”¨å˜æ¢çŸ©é˜µï¼ˆç¼©æ”¾ã€æ—‹è½¬ã€å¹³ç§»ï¼‰
       - ç»˜åˆ¶åˆ°ç”»å¸ƒ

    3. é®ç½©æ•ˆæœ
       - ç»˜åˆ¶åœ†å¤–æš—åŒ–åŒºåŸŸ
       - ç»˜åˆ¶å‡ºè¡€åŒºåŸŸåŠé€æ˜æ•ˆæœ
       - åº”ç”¨ç”¨æˆ·è®¾ç½®çš„é€æ˜åº¦

    4. è¾…åŠ©å…ƒç´ 
       - ç»˜åˆ¶åœ†å½¢è¾¹æ¡†
       - ç»˜åˆ¶å®‰å…¨åŒºåŸŸæŒ‡ç¤ºåœ†
       - ç»˜åˆ¶ä¸­å¿ƒåå­—çº¿
       - æ·»åŠ å°ºå¯¸æ ‡æ³¨
    """
    painter = QPainter(self)
    painter.setRenderHint(QPainter.RenderHint.Antialiasing)

    # ç»˜åˆ¶å›¾ç‰‡
    if self.original_image:
        pixmap = self.create_image_pixmap()
        if pixmap:
            img_rect = self.get_image_rect()
            painter.drawPixmap(img_rect, pixmap)

    # ç»˜åˆ¶é®ç½©å’Œè¾…åŠ©å…ƒç´ 
    self.draw_overlay_elements(painter)
```

#### 2. é¼ æ ‡äº¤äº’å¤„ç†
```python
def mousePressEvent(self, event):
    """è®°å½•æ‹–æ‹½èµ·å§‹ç‚¹"""
    if event.button() == Qt.MouseButton.LeftButton:
        self.drag_start_pos = event.position()
        self.drag_start_offset_x = self.offset_x
        self.drag_start_offset_y = self.offset_y

def mouseMoveEvent(self, event):
    """
    æ‹–æ‹½ç§»åŠ¨ç®—æ³•ï¼š
    1. è®¡ç®—é¼ æ ‡ç§»åŠ¨è·ç¦»ï¼ˆåƒç´ ï¼‰
    2. è½¬æ¢ä¸ºå®é™…å›¾ç‰‡åæ ‡ç³»çš„åç§»
    3. è€ƒè™‘å½“å‰ç¼©æ”¾æ¯”ä¾‹çš„å½±å“
    4. æ›´æ–°åç§»å‚æ•°å¹¶è§¦å‘é‡ç»˜
    """
    if self.drag_start_pos is not None:
        # è®¡ç®—é¼ æ ‡ç§»åŠ¨è·ç¦»
        delta = event.position() - self.drag_start_pos

        # è½¬æ¢ä¸ºå®é™…åæ ‡åç§»
        # è€ƒè™‘æ˜¾ç¤ºæ¯”ä¾‹å’Œå›¾ç‰‡ç¼©æ”¾çš„å½±å“
        actual_delta_x = delta.x() / self.display_to_actual_ratio / self.image_scale
        actual_delta_y = delta.y() / self.display_to_actual_ratio / self.image_scale

        # æ›´æ–°åç§»é‡
        self.offset_x = self.drag_start_offset_x + actual_delta_x
        self.offset_y = self.drag_start_offset_y + actual_delta_y

        # è§¦å‘é‡ç»˜å’Œå‚æ•°æ›´æ–°
        self.update()
        self.parameters_changed.emit(self.image_scale, self.offset_x, self.offset_y)

def wheelEvent(self, event):
    """
    æ»šè½®ç¼©æ”¾ç®—æ³•ï¼š
    1. è®¡ç®—ç¼©æ”¾å› å­ï¼ˆ1.05æˆ–1/1.05ï¼‰
    2. åº”ç”¨ç¼©æ”¾é™åˆ¶ï¼ˆ0.1-10.0å€ï¼‰
    3. ä½¿ç”¨é˜²æŠ–å®šæ—¶å™¨ä¼˜åŒ–æ€§èƒ½
    4. ç«‹å³æ›´æ–°æ˜¾ç¤ºï¼Œå»¶è¿Ÿæ›´æ–°ç¼“å­˜
    """
    delta = event.angleDelta().y()
    zoom_factor = 1.05 if delta > 0 else 1.0 / 1.05

    new_scale = self.image_scale * zoom_factor
    new_scale = max(self.min_scale, min(self.max_scale, new_scale))

    if new_scale != self.image_scale:
        self.image_scale = new_scale
        self.update()  # ç«‹å³æ›´æ–°æ˜¾ç¤º

        # ä½¿ç”¨é˜²æŠ–å®šæ—¶å™¨å»¶è¿Ÿæ›´æ–°ç¼“å­˜
        self._scale_timer.stop()
        self._scale_timer.start(50)  # 50mså»¶è¿Ÿ
```

### å¯¼å‡ºç®¡ç†å™¨å®ç° (export_manager.py)

#### 1. é«˜åˆ†è¾¨ç‡å¯¼å‡ºç®—æ³•
```python
def export_layout(self, image_items, layout_type, spacing_mm, margin_mm,
                 output_path, format_type='PNG', dpi=300):
    """
    é«˜åˆ†è¾¨ç‡å¯¼å‡ºæµç¨‹ï¼š

    1. åˆ›å»ºé«˜åˆ†è¾¨ç‡ç”»å¸ƒ
       - æ ¹æ®DPIè®¡ç®—ç²¾ç¡®åƒç´ å°ºå¯¸
       - åˆ›å»ºç©ºç™½çš„PIL Imageå¯¹è±¡
       - è®¾ç½®ç™½è‰²èƒŒæ™¯

    2. å¤„ç†æ¯ä¸ªå›¾ç‰‡
       - ä½¿ç”¨åŸå§‹åˆ†è¾¨ç‡è¿›è¡Œå¤„ç†
       - åº”ç”¨ç”¨æˆ·è®¾ç½®çš„ç¼–è¾‘å‚æ•°
       - è¿›è¡Œé«˜è´¨é‡çš„åœ†å½¢è£å‰ª

    3. ç²¾ç¡®å®šä½
       - å°†æ¯«ç±³åæ ‡è½¬æ¢ä¸ºé«˜åˆ†è¾¨ç‡åƒç´ åæ ‡
       - ç¡®ä¿ä½ç½®ç²¾åº¦è¾¾åˆ°æ‰“å°è¦æ±‚
       - å¤„ç†å›¾ç‰‡è¾¹ç•Œå’Œé‡å 

    4. æ ¼å¼è¾“å‡º
       - æ ¹æ®æ ¼å¼è®¾ç½®å‹ç¼©å‚æ•°
       - ä¿å­˜EXIFä¿¡æ¯ï¼ˆDPIç­‰ï¼‰
       - ä¼˜åŒ–æ–‡ä»¶å¤§å°
    """
    # åˆ›å»ºé«˜åˆ†è¾¨ç‡ç”»å¸ƒ
    canvas_width = int(210 * dpi / 25.4)  # A4å®½åº¦
    canvas_height = int(297 * dpi / 25.4)  # A4é«˜åº¦
    canvas = Image.new('RGB', (canvas_width, canvas_height), 'white')

    # è·å–å¸ƒå±€ä½ç½®
    layout = self.layout_engine.calculate_layout(layout_type, spacing_mm, margin_mm)

    # å¤„ç†æ¯ä¸ªå›¾ç‰‡
    for i, image_item in enumerate(image_items):
        if i >= len(layout['positions']):
            break

        # è·å–é«˜åˆ†è¾¨ç‡çš„åœ†å½¢å›¾ç‰‡
        processed_image = self.image_processor.create_circular_crop(
            image_item, target_dpi=dpi
        )

        # è®¡ç®—ç²¾ç¡®ä½ç½®
        pos_x, pos_y = layout['positions'][i]
        pos_x = int(pos_x * dpi / 300)  # è½¬æ¢åˆ°ç›®æ ‡DPI
        pos_y = int(pos_y * dpi / 300)

        # ç²˜è´´åˆ°ç”»å¸ƒ
        canvas.paste(processed_image, (pos_x, pos_y), processed_image)

    # ä¿å­˜æ–‡ä»¶
    save_kwargs = {'dpi': (dpi, dpi)}
    if format_type.upper() == 'JPEG':
        save_kwargs['quality'] = 95
        save_kwargs['optimize'] = True

    canvas.save(output_path, format=format_type, **save_kwargs)
```

#### 2. PDFå¤šé¡µé¢å¯¼å‡º
```python
def export_to_pdf(self, image_items, layout_type, spacing_mm, margin_mm, output_path):
    """
    PDFå¤šé¡µé¢å¯¼å‡ºï¼š
    1. è®¡ç®—æ€»é¡µæ•°å’Œæ¯é¡µå†…å®¹
    2. ä¸ºæ¯é¡µç”Ÿæˆé«˜åˆ†è¾¨ç‡å›¾åƒ
    3. ä½¿ç”¨PILåˆ›å»ºPDFæ–‡æ¡£
    4. è®¾ç½®é¡µé¢å°ºå¯¸å’Œè¾¹è·
    5. åˆå¹¶æ‰€æœ‰é¡µé¢åˆ°å•ä¸ªPDFæ–‡ä»¶
    """
    from PIL import Image

    # è®¡ç®—å¤šé¡µé¢å¸ƒå±€
    multi_layout = self.layout_engine.calculate_multi_page_layout(
        len(image_items), layout_type, spacing_mm, margin_mm
    )

    pdf_pages = []
    image_index = 0

    # ç”Ÿæˆæ¯ä¸€é¡µ
    for page_info in multi_layout['pages']:
        page_images = image_items[image_index:image_index + page_info['images_on_page']]

        # ç”Ÿæˆå½“å‰é¡µçš„é«˜åˆ†è¾¨ç‡å›¾åƒ
        page_image = self.create_page_image(page_images, page_info, layout_type,
                                          spacing_mm, margin_mm, dpi=300)
        pdf_pages.append(page_image)
        image_index += page_info['images_on_page']

    # ä¿å­˜ä¸ºPDF
    if pdf_pages:
        pdf_pages[0].save(output_path, format='PDF', save_all=True,
                         append_images=pdf_pages[1:], resolution=300.0)
```

### é…ç½®ç®¡ç†ç³»ç»Ÿè¯¦è§£ (config.py)

#### 1. åŠ¨æ€é…ç½®æ›´æ–°æœºåˆ¶
```python
class AppConfig:
    def __init__(self):
        self._listeners = []  # é…ç½®å˜åŒ–ç›‘å¬å™¨åˆ—è¡¨
        self._config_data = {}  # é…ç½®æ•°æ®å­˜å‚¨

    def set_value(self, key, value):
        """
        é…ç½®æ›´æ–°æµç¨‹ï¼š
        1. éªŒè¯æ–°å€¼çš„æœ‰æ•ˆæ€§
        2. ä¿å­˜æ—§å€¼ç”¨äºå›æ»š
        3. æ›´æ–°é…ç½®å€¼
        4. é€šçŸ¥æ‰€æœ‰ç›‘å¬å™¨
        5. è§¦å‘ç›¸å…³ç»„ä»¶æ›´æ–°
        """
        old_value = self._config_data.get(key)
        if old_value != value:
            self._config_data[key] = value
            self._notify_listeners(key, old_value, value)

    def _notify_listeners(self, key, old_value, new_value):
        """é€šçŸ¥æ‰€æœ‰æ³¨å†Œçš„ç›‘å¬å™¨"""
        for listener in self._listeners:
            try:
                listener(key, old_value, new_value)
            except Exception as e:
                logger.error(f"é…ç½®ç›‘å¬å™¨æ‰§è¡Œå¤±è´¥: {e}")
```

#### 2. å¾½ç« å°ºå¯¸è®¡ç®—é€»è¾‘
```python
@property
def badge_diameter_mm(self):
    """
    æ€»ç›´å¾„è®¡ç®—å…¬å¼ï¼š
    æ€»ç›´å¾„ = å¾½ç« ç›´å¾„ + å‡ºè¡€åŠå¾„ Ã— 2

    ä¾‹å¦‚ï¼š58mmå¾½ç«  + 5mmå‡ºè¡€åŠå¾„ = 68mmæ€»ç›´å¾„
    è¿™ç¡®ä¿äº†æ‰“å°æ—¶çš„å®‰å…¨è¾¹è·
    """
    return self.badge_size_mm + self.bleed_size_mm * 2

@property
def badge_radius_px(self):
    """å°†å¾½ç« åŠå¾„è½¬æ¢ä¸ºåƒç´ ï¼ˆ300 DPIæ ‡å‡†ï¼‰"""
    radius_mm = self.badge_diameter_mm / 2
    return int(radius_mm * 300 / 25.4)

@property
def badge_diameter_px(self):
    """å°†å¾½ç« ç›´å¾„è½¬æ¢ä¸ºåƒç´ """
    return self.badge_radius_px * 2
```

### æ–‡ä»¶å¤„ç†ç³»ç»Ÿ (file_handler.py)

#### 1. å›¾ç‰‡æ–‡ä»¶éªŒè¯
```python
class FileHandler:
    SUPPORTED_FORMATS = {'.png', '.jpg', '.jpeg', '.bmp', '.gif'}
    MAX_FILE_SIZE = 50 * 1024 * 1024  # 50MBé™åˆ¶

    def validate_image_file(self, file_path):
        """
        æ–‡ä»¶éªŒè¯æµç¨‹ï¼š
        1. æ£€æŸ¥æ–‡ä»¶æ‰©å±•å
        2. éªŒè¯æ–‡ä»¶å¤§å°
        3. å°è¯•æ‰“å¼€å›¾ç‰‡æ–‡ä»¶
        4. æ£€æŸ¥å›¾ç‰‡å°ºå¯¸åˆç†æ€§
        5. éªŒè¯è‰²å½©æ¨¡å¼æ”¯æŒ
        """
        # æ‰©å±•åæ£€æŸ¥
        ext = Path(file_path).suffix.lower()
        if ext not in self.SUPPORTED_FORMATS:
            raise ValueError(f"ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: {ext}")

        # æ–‡ä»¶å¤§å°æ£€æŸ¥
        file_size = os.path.getsize(file_path)
        if file_size > self.MAX_FILE_SIZE:
            raise ValueError(f"æ–‡ä»¶è¿‡å¤§: {file_size / 1024 / 1024:.1f}MB")

        # å›¾ç‰‡å®Œæ•´æ€§æ£€æŸ¥
        try:
            with Image.open(file_path) as img:
                img.verify()  # éªŒè¯å›¾ç‰‡å®Œæ•´æ€§
        except Exception as e:
            raise ValueError(f"å›¾ç‰‡æ–‡ä»¶æŸå: {e}")

        return True
```

#### 2. ImageItemæ•°æ®æ¨¡å‹
```python
class ImageItem:
    """
    å›¾ç‰‡é¡¹æ•°æ®æ¨¡å‹ï¼š
    å°è£…å•ä¸ªå›¾ç‰‡çš„æ‰€æœ‰ç›¸å…³ä¿¡æ¯å’Œç¼–è¾‘å‚æ•°
    """
    def __init__(self, file_path):
        self.file_path = file_path
        self.filename = Path(file_path).name

        # ç¼–è¾‘å‚æ•°
        self.scale = 1.0        # ç¼©æ”¾æ¯”ä¾‹
        self.offset_x = 0       # Xè½´åç§»ï¼ˆåƒç´ ï¼‰
        self.offset_y = 0       # Yè½´åç§»ï¼ˆåƒç´ ï¼‰
        self.rotation = 0       # æ—‹è½¬è§’åº¦ï¼ˆåº¦ï¼‰
        self.quantity = 1       # æ•°é‡

        # çŠ¶æ€æ ‡è®°
        self.is_processed = False  # æ˜¯å¦å·²ç¼–è¾‘
        self.thumbnail = None      # ç¼©ç•¥å›¾ç¼“å­˜

    def get_display_name(self):
        """è·å–æ˜¾ç¤ºåç§°ï¼ˆæ–‡ä»¶å + æ•°é‡ï¼‰"""
        if self.quantity > 1:
            return f"{self.filename} (Ã—{self.quantity})"
        return self.filename

    def get_processing_params(self):
        """è·å–å›¾ç‰‡å¤„ç†å‚æ•°å¯¹è±¡"""
        return ImageProcessParams(
            image_path=self.file_path,
            scale=self.scale,
            offset_x=self.offset_x,
            offset_y=self.offset_y,
            rotation=self.rotation
        )
```

### é”™è¯¯å¤„ç†å’Œæ—¥å¿—ç³»ç»Ÿ (error_handler.py)

#### 1. ç»Ÿä¸€é”™è¯¯å¤„ç†
```python
import logging
from PySide6.QtWidgets import QMessageBox

# é…ç½®æ—¥å¿—ç³»ç»Ÿ
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('badge_tool.log', encoding='utf-8'),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger('BadgePatternTool')

def show_error_message(title, message, parent=None):
    """æ˜¾ç¤ºé”™è¯¯å¯¹è¯æ¡†å¹¶è®°å½•æ—¥å¿—"""
    logger.error(f"{title}: {message}")
    QMessageBox.critical(parent, title, message)

def show_warning_message(title, message, parent=None):
    """æ˜¾ç¤ºè­¦å‘Šå¯¹è¯æ¡†å¹¶è®°å½•æ—¥å¿—"""
    logger.warning(f"{title}: {message}")
    QMessageBox.warning(parent, title, message)

def show_info_message(title, message, parent=None):
    """æ˜¾ç¤ºä¿¡æ¯å¯¹è¯æ¡†å¹¶è®°å½•æ—¥å¿—"""
    logger.info(f"{title}: {message}")
    QMessageBox.information(parent, title, message)
```

#### 2. å¼‚å¸¸å¤„ç†è£…é¥°å™¨
```python
def handle_exceptions(func):
    """
    å¼‚å¸¸å¤„ç†è£…é¥°å™¨ï¼š
    è‡ªåŠ¨æ•è·å’Œå¤„ç†å‡½æ•°ä¸­çš„å¼‚å¸¸
    è®°å½•è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
    å‘ç”¨æˆ·æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º
    """
    def wrapper(*args, **kwargs):
        try:
            return func(*args, **kwargs)
        except Exception as e:
            logger.error(f"å‡½æ•° {func.__name__} æ‰§è¡Œå¤±è´¥: {e}", exc_info=True)
            show_error_message("æ“ä½œå¤±è´¥", f"æ‰§è¡Œ {func.__name__} æ—¶å‘ç”Ÿé”™è¯¯ï¼š{str(e)}")
            return None
    return wrapper

# ä½¿ç”¨ç¤ºä¾‹
@handle_exceptions
def load_and_process_image(file_path):
    """åŠ è½½å’Œå¤„ç†å›¾ç‰‡ï¼ˆè‡ªåŠ¨å¼‚å¸¸å¤„ç†ï¼‰"""
    # å…·ä½“å®ç°...
```

### æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–

#### 1. å†…å­˜ä½¿ç”¨ç›‘æ§
```python
import psutil
import gc

class PerformanceMonitor:
    def __init__(self):
        self.process = psutil.Process()

    def get_memory_usage(self):
        """è·å–å½“å‰å†…å­˜ä½¿ç”¨æƒ…å†µ"""
        memory_info = self.process.memory_info()
        return {
            'rss': memory_info.rss / 1024 / 1024,  # MB
            'vms': memory_info.vms / 1024 / 1024,  # MB
            'percent': self.process.memory_percent()
        }

    def force_garbage_collection(self):
        """å¼ºåˆ¶åƒåœ¾å›æ”¶"""
        collected = gc.collect()
        logger.info(f"åƒåœ¾å›æ”¶å®Œæˆï¼Œæ¸…ç†äº† {collected} ä¸ªå¯¹è±¡")
        return collected

    def log_performance_stats(self):
        """è®°å½•æ€§èƒ½ç»Ÿè®¡ä¿¡æ¯"""
        memory = self.get_memory_usage()
        cpu_percent = self.process.cpu_percent()

        logger.info(f"æ€§èƒ½ç»Ÿè®¡ - å†…å­˜: {memory['rss']:.1f}MB "
                   f"({memory['percent']:.1f}%), CPU: {cpu_percent:.1f}%")
```

#### 2. ç¼“å­˜ç®¡ç†ç­–ç•¥
```python
class CacheManager:
    def __init__(self, max_size=100):
        self.max_size = max_size
        self.cache = {}
        self.access_order = []  # LRUè®¿é—®é¡ºåº

    def get(self, key):
        """è·å–ç¼“å­˜é¡¹ï¼ˆLRUç­–ç•¥ï¼‰"""
        if key in self.cache:
            # æ›´æ–°è®¿é—®é¡ºåº
            self.access_order.remove(key)
            self.access_order.append(key)
            return self.cache[key]
        return None

    def put(self, key, value):
        """æ·»åŠ ç¼“å­˜é¡¹"""
        if key in self.cache:
            # æ›´æ–°ç°æœ‰é¡¹
            self.cache[key] = value
            self.access_order.remove(key)
            self.access_order.append(key)
        else:
            # æ·»åŠ æ–°é¡¹
            if len(self.cache) >= self.max_size:
                # ç§»é™¤æœ€ä¹…æœªä½¿ç”¨çš„é¡¹
                oldest_key = self.access_order.pop(0)
                del self.cache[oldest_key]

            self.cache[key] = value
            self.access_order.append(key)

    def clear(self):
        """æ¸…ç©ºç¼“å­˜"""
        self.cache.clear()
        self.access_order.clear()
        logger.info("ç¼“å­˜å·²æ¸…ç©º")
```

### æµ‹è¯•æ¡†æ¶å’Œè´¨é‡ä¿è¯

#### 1. å•å…ƒæµ‹è¯•ç¤ºä¾‹
```python
import unittest
from unittest.mock import Mock, patch
from core.image_processor import ImageProcessor

class TestImageProcessor(unittest.TestCase):
    def setUp(self):
        """æµ‹è¯•å‰å‡†å¤‡"""
        self.processor = ImageProcessor()
        self.test_image_path = "tests/assets/test_image.jpg"

    def test_load_image_success(self):
        """æµ‹è¯•å›¾ç‰‡åŠ è½½æˆåŠŸåœºæ™¯"""
        image = self.processor.load_image(self.test_image_path)
        self.assertIsNotNone(image)
        self.assertEqual(image.mode, 'RGB')

    def test_load_image_invalid_path(self):
        """æµ‹è¯•æ— æ•ˆè·¯å¾„å¤„ç†"""
        image = self.processor.load_image("invalid_path.jpg")
        self.assertIsNone(image)

    def test_circular_crop_algorithm(self):
        """æµ‹è¯•åœ†å½¢è£å‰ªç®—æ³•"""
        # åˆ›å»ºæµ‹è¯•å‚æ•°
        params = Mock()
        params.scale = 1.0
        params.offset_x = 0
        params.offset_y = 0
        params.rotation = 0

        # æ‰§è¡Œè£å‰ª
        result = self.processor.create_circular_crop(params)

        # éªŒè¯ç»“æœ
        self.assertIsNotNone(result)
        self.assertEqual(result.mode, 'RGBA')  # åº”è¯¥æœ‰é€æ˜é€šé“
```

#### 2. é›†æˆæµ‹è¯•æ¡†æ¶
```python
class IntegrationTest(unittest.TestCase):
    def test_complete_workflow(self):
        """æµ‹è¯•å®Œæ•´çš„å·¥ä½œæµç¨‹"""
        # 1. å¯¼å…¥å›¾ç‰‡
        file_handler = FileHandler()
        image_items = file_handler.load_images(["test1.jpg", "test2.jpg"])

        # 2. ç¼–è¾‘å›¾ç‰‡
        for item in image_items:
            item.scale = 1.5
            item.offset_x = 10
            item.offset_y = -5

        # 3. ç”Ÿæˆå¸ƒå±€
        layout_engine = LayoutEngine()
        layout = layout_engine.calculate_grid_layout(3, 6)

        # 4. å¯¼å‡ºç»“æœ
        export_manager = ExportManager()
        success = export_manager.export_layout(
            image_items, 'grid', 3, 6, 'test_output.png'
        )

        # éªŒè¯ç»“æœ
        self.assertTrue(success)
        self.assertTrue(os.path.exists('test_output.png'))
```

### éƒ¨ç½²å’Œæ‰“åŒ…

#### 1. PyInstalleré…ç½®
```python
# build.py - è‡ªåŠ¨åŒ–æ„å»ºè„šæœ¬
import PyInstaller.__main__
import shutil
import os

def build_executable():
    """æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶"""
    PyInstaller.__main__.run([
        'src/main.py',
        '--name=BadgePatternTool',
        '--windowed',
        '--onefile',
        '--icon=src/assets/icon.ico',
        '--add-data=src/assets;assets',
        '--hidden-import=PIL._tkinter_finder',
        '--clean',
        '--noconfirm'
    ])

    # å¤åˆ¶å¿…è¦æ–‡ä»¶
    shutil.copy('README.md', 'dist/')
    shutil.copy('LICENSE', 'dist/')

    print("æ„å»ºå®Œæˆï¼å¯æ‰§è¡Œæ–‡ä»¶ä½äº dist/ ç›®å½•")

if __name__ == "__main__":
    build_executable()
```

#### 2. ç‰ˆæœ¬ç®¡ç†
```python
# version.py - ç‰ˆæœ¬ä¿¡æ¯ç®¡ç†
__version__ = "1.5.5"
__build_date__ = "2025-06-20"
__author__ = "BadgePatternTool Team"

def get_version_info():
    """è·å–å®Œæ•´ç‰ˆæœ¬ä¿¡æ¯"""
    return {
        'version': __version__,
        'build_date': __build_date__,
        'author': __author__,
        'python_version': sys.version,
        'pyside_version': PySide6.__version__
    }
```

## ğŸ“š å¼€å‘æœ€ä½³å®è·µ

### 1. ä»£ç è§„èŒƒ
- éµå¾ª PEP 8 ç¼–ç æ ‡å‡†
- ä½¿ç”¨ç±»å‹æç¤ºå¢å¼ºä»£ç å¯è¯»æ€§
- ç¼–å†™è¯¦ç»†çš„æ–‡æ¡£å­—ç¬¦ä¸²
- ä¿æŒå‡½æ•°å’Œç±»çš„å•ä¸€èŒè´£

### 2. æ€§èƒ½ä¼˜åŒ–
- ä½¿ç”¨ç¼“å­˜å‡å°‘é‡å¤è®¡ç®—
- å®ç°é˜²æŠ–æœºåˆ¶ä¼˜åŒ–ç”¨æˆ·äº¤äº’
- åˆç†ä½¿ç”¨å¤šçº¿ç¨‹å¤„ç†è€—æ—¶æ“ä½œ
- å®šæœŸè¿›è¡Œå†…å­˜æ¸…ç†

### 3. é”™è¯¯å¤„ç†
- å®ç°å…¨å±€å¼‚å¸¸å¤„ç†æœºåˆ¶
- æä¾›ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
- è®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- è®¾è®¡ä¼˜é›…çš„é™çº§ç­–ç•¥

### 4. æµ‹è¯•ç­–ç•¥
- ç¼–å†™å…¨é¢çš„å•å…ƒæµ‹è¯•
- å®æ–½é›†æˆæµ‹è¯•éªŒè¯å·¥ä½œæµ
- è¿›è¡Œæ€§èƒ½æµ‹è¯•ç¡®ä¿å“åº”é€Ÿåº¦
- å®šæœŸè¿›è¡Œä»£ç å®¡æŸ¥

è¿™ä»½å…¨é¢çš„æŠ€æœ¯æ–‡æ¡£ä¸ºå›¢é˜Ÿæä¾›äº†æ·±å…¥çš„ä»£ç ç†è§£ï¼Œæ¶µç›–äº†ä»æ ¸å¿ƒç®—æ³•åˆ°éƒ¨ç½²å®è·µçš„å„ä¸ªæ–¹é¢ï¼Œæœ‰åŠ©äºæ–°æˆå‘˜å¿«é€Ÿä¸Šæ‰‹å’Œé¡¹ç›®çš„é•¿æœŸç»´æŠ¤ã€‚
