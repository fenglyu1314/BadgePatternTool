# BadgePatternTool 交互式图片编辑器功能说明

## 🎯 功能概述

新的交互式图片编辑器提供了更直观的单图编辑体验，用户可以在预览窗口中看到完整图片，并通过圆形遮罩预览裁剪效果。

### ✨ 主要特性

1. **完整图片显示**：在编辑器中显示完整的原始图片
2. **圆形遮罩预览**：叠加圆形遮罩，预览最终裁剪效果
3. **暗化区域**：圆形外部区域变暗，突出裁剪区域
4. **交互式操作**：支持鼠标拖拽移动和滚轮缩放
5. **实时同步**：与滑块控件双向同步

## 🎨 视觉设计

### 界面布局
```
┌─────────────────────────────────────┐
│        交互式编辑器 (320x280)        │
│  ┌─────────────────────────────────┐ │
│  │                                 │ │
│  │     完整图片显示区域             │ │
│  │                                 │ │
│  │        ○ 圆形遮罩               │ │
│  │      (白色虚线边框)             │ │
│  │                                 │ │
│  │     圆形外部区域变暗             │ │
│  │                                 │ │
│  └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

### 视觉效果
- **背景色**：浅灰色 (#f0f0f0)
- **图片显示**：完整原始图片
- **圆形遮罩**：
  - 边框：白色虚线 (2px)
  - 内部：图片清晰显示
  - 外部：半透明黑色遮罩 (alpha=100)
- **中心十字线**：白色点线，帮助定位

## 🖱️ 交互操作

### 鼠标操作
1. **拖拽移动**：
   - 在图片区域按住左键拖拽
   - 实时移动图片位置
   - 光标变为手型 (OpenHandCursor/ClosedHandCursor)

2. **滚轮缩放**：
   - 向上滚动：放大图片 (缩放因子 1.1)
   - 向下滚动：缩小图片 (缩放因子 1/1.1)
   - 缩放范围：0.1x - 5.0x

3. **光标提示**：
   - 无图片：箭头光标
   - 有图片悬停：手型光标
   - 拖拽中：抓取光标

### 键盘操作
- 通过滑块控件进行精确调整
- 支持键盘方向键操作滑块

## 🔧 技术实现

### 核心类：InteractiveImageEditor

#### 主要属性
```python
class InteractiveImageEditor(QLabel):
    # 图片相关
    self.original_image = None      # PIL Image对象
    self.image_path = None          # 图片路径
    
    # 编辑参数
    self.image_scale = 1.0          # 图片缩放比例
    self.image_offset = QPoint(0, 0) # 图片偏移
    self.mask_radius = 120          # 圆形遮罩半径
    
    # 交互状态
    self.dragging = False           # 拖拽状态
    self.last_drag_point = QPoint() # 上次拖拽点
```

#### 关键方法

1. **load_image(image_path)**：
   - 加载图片文件
   - 计算初始缩放比例
   - 重置偏移位置

2. **paintEvent(event)**：
   - 自定义绘制完整界面
   - 绘制图片、遮罩、边框、十字线

3. **wheelEvent(event)**：
   - 处理滚轮缩放
   - 限制缩放范围
   - 发送参数改变信号

4. **mousePressEvent/mouseMoveEvent/mouseReleaseEvent**：
   - 处理拖拽操作
   - 更新图片位置
   - 管理光标状态

### 信号机制
```python
# 参数改变信号
parameters_changed = Signal(float, int, int)  # scale, offset_x, offset_y
```

## 🔄 与现有系统集成

### 双向同步机制

1. **编辑器 → 滑块**：
   ```python
   def on_editor_parameters_changed(self, scale, offset_x, offset_y):
       # 更新CircleEditor参数
       self.current_editor.scale = scale
       self.current_editor.offset_x = offset_x
       self.current_editor.offset_y = offset_y
       
       # 同步滑块值（阻止信号循环）
       self.scale_slider.blockSignals(True)
       self.scale_slider.setValue(int(scale * 100))
       self.scale_slider.blockSignals(False)
   ```

2. **滑块 → 编辑器**：
   ```python
   def on_scale_change(self, value):
       scale = value / 100.0
       # 同步到交互式编辑器
       self.interactive_editor.image_scale = scale
       self.interactive_editor.update()
   ```

### 兼容性保持
- 保留原有的CircleEditor类
- 滑块控件功能不变
- 应用编辑、重置编辑等功能正常工作
- A4排版预览正常更新

## 📋 使用流程

### 基本操作流程
1. **导入图片**：点击"导入图片"按钮选择图片文件
2. **选择图片**：在左侧列表中选择要编辑的图片
3. **交互编辑**：
   - 在交互式编辑器中拖拽移动图片
   - 使用滚轮缩放图片大小
   - 观察圆形遮罩预览效果
4. **精确调整**：使用下方滑块进行精确调整
5. **应用编辑**：点击"应用编辑"保存参数
6. **查看效果**：在A4排版预览中查看最终效果

### 高级功能
- **重置编辑**：恢复到最佳初始参数
- **自动排版**：为所有图片应用最佳参数
- **数量设置**：设置每张图片的复制数量

## 🎯 用户体验改进

### 相比原版的优势

1. **直观性**：
   - ✅ 看到完整图片，而不只是裁剪结果
   - ✅ 实时预览裁剪区域
   - ✅ 暗化效果突出重点区域

2. **交互性**：
   - ✅ 鼠标直接操作，更自然
   - ✅ 滚轮缩放，操作便捷
   - ✅ 拖拽移动，精确定位

3. **效率性**：
   - ✅ 实时反馈，无需等待
   - ✅ 双向同步，灵活操作
   - ✅ 视觉引导，减少试错

### 解决的问题
- **问题1**：原版只能看到裁剪后的圆形结果
  - **解决**：显示完整图片 + 圆形遮罩预览

- **问题2**：不知道图片的哪部分被裁剪
  - **解决**：暗化圆形外部区域，突出裁剪区域

- **问题3**：调整参数需要依赖滑块
  - **解决**：支持鼠标直接拖拽和滚轮缩放

- **问题4**：编辑过程不够直观
  - **解决**：所见即所得的编辑体验

## 🔧 技术细节

### 绘制流程
1. **背景绘制**：填充浅灰色背景
2. **图片绘制**：绘制缩放后的完整图片
3. **遮罩绘制**：创建暗化遮罩（排除圆形区域）
4. **边框绘制**：绘制白色虚线圆形边框
5. **十字线绘制**：绘制中心定位十字线

### 坐标转换
```python
def get_image_rect(self):
    """计算图片显示矩形"""
    # 缩放后尺寸
    scaled_width = int(img_width * self.image_scale)
    scaled_height = int(img_height * self.image_scale)
    
    # 居中位置 + 用户偏移
    img_x = editor_center_x - scaled_width // 2 + self.image_offset.x()
    img_y = editor_center_y - scaled_height // 2 + self.image_offset.y()
    
    return QRect(img_x, img_y, scaled_width, scaled_height)
```

### 遮罩实现
```python
def draw_darkening_mask(self, painter, img_rect, mask_rect):
    """绘制暗化遮罩"""
    # 创建图片区域路径
    full_path = QPainterPath()
    full_path.addRect(intersection)
    
    # 创建圆形路径
    circle_path = QPainterPath()
    circle_path.addEllipse(mask_rect)
    
    # 从图片区域减去圆形区域
    darkening_path = full_path.subtracted(circle_path)
    
    # 绘制半透明暗化区域
    painter.fillPath(darkening_path, QColor(0, 0, 0, 100))
```

## 🚀 后续扩展

### 可能的改进方向
1. **多形状支持**：支持方形、六边形等其他形状
2. **网格辅助线**：添加网格线帮助对齐
3. **缩放中心**：支持以鼠标位置为中心缩放
4. **快捷键**：添加键盘快捷键支持
5. **预设位置**：提供常用位置预设（居中、左上等）

### 性能优化
1. **图片缓存**：缓存缩放后的图片避免重复计算
2. **绘制优化**：只重绘变化的区域
3. **内存管理**：及时释放不需要的图片资源

---

## 🎉 总结

新的交互式图片编辑器显著提升了BadgePatternTool的用户体验：

**主要成就**：
- ✅ 实现了直观的图片编辑界面
- ✅ 提供了实时的裁剪预览效果
- ✅ 支持自然的鼠标交互操作
- ✅ 保持了与现有系统的完美兼容

**用户价值**：
- 🎯 编辑过程更加直观和高效
- 🎯 减少了试错时间和操作复杂度
- 🎯 提供了专业级的编辑体验

这个功能让BadgePatternTool的单图编辑体验达到了专业图像编辑软件的水准！
