name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ä»¥vå¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚v1.4.1ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# æ·»åŠ å¿…è¦çš„æƒé™
permissions:
  contents: write  # å…è®¸åˆ›å»ºreleaseå’Œä¸Šä¼ æ–‡ä»¶
  actions: read    # å…è®¸è¯»å–actions
  checks: write    # å…è®¸å†™å…¥æ£€æŸ¥ç»“æœ

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'  # ä½¿ç”¨ç¨³å®šçš„Pythonç‰ˆæœ¬
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller>=5.0.0
        
    - name: Verify project structure
      run: |
        echo "=== é¡¹ç›®ç»“æ„æ£€æŸ¥ ==="
        Get-ChildItem -Force
        echo "=== srcç›®å½• ==="
        Get-ChildItem src/ -Force
        echo "=== assetsç›®å½• ==="
        if (Test-Path "src/assets") { Get-ChildItem src/assets/ -Force } else { echo "assetsç›®å½•ä¸å­˜åœ¨" }
        
    - name: Run CI tests
      run: |
        echo "=== è¿è¡ŒCIå®‰å…¨æµ‹è¯• ==="
        python scripts/ci_tests.py
        
    - name: Build executable
      run: |
        echo "=== å¼€å§‹æ„å»º ==="
        python scripts/build.py
        
    - name: Verify build output
      run: |
        echo "=== æ„å»ºç»“æœæ£€æŸ¥ ==="
        Get-ChildItem dist/ -Force
        if (Test-Path "dist/BadgePatternTool.exe") {
          $size = (Get-Item "dist/BadgePatternTool.exe").Length / 1MB
          echo "âœ… å¯æ‰§è¡Œæ–‡ä»¶å¤§å°: $([math]::Round($size, 1)) MB"
        } else {
          echo "âŒ å¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°"
          exit 1
        }
        
    - name: Extract version info
      id: version
      run: |
        $version = "${{ github.ref_name }}"
        $versionNumber = $version -replace '^v', ''
        echo "VERSION=$version" >> $env:GITHUB_ENV
        echo "VERSION_NUMBER=$versionNumber" >> $env:GITHUB_ENV
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "version_number=$versionNumber" >> $env:GITHUB_OUTPUT

    - name: Create release files
      run: |
        echo "=== å‡†å¤‡å‘å¸ƒæ–‡ä»¶ ==="
        # åˆ›å»ºå‘å¸ƒç›®å½•
        mkdir release

        # å¤åˆ¶ä¸»è¦æ–‡ä»¶åˆ°å‘å¸ƒç›®å½•
        Copy-Item "dist/BadgePatternTool.exe" "release/"
        Copy-Item "dist/README.md" "release/" -ErrorAction SilentlyContinue
        Copy-Item "dist/User_Guide.txt" "release/" -ErrorAction SilentlyContinue

        # ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„ç‰ˆæœ¬å·
        $version = "${{ env.VERSION }}"
        $zipName = "BadgePatternTool-$version-Windows.zip"
        $exeName = "BadgePatternTool-$version.exe"

        # åˆ›å»ºZIPæ–‡ä»¶ï¼ˆåŒ…å«æ‰€æœ‰æ–‡ä»¶ï¼‰
        Compress-Archive -Path "release/*" -DestinationPath $zipName

        # å¤åˆ¶å•ç‹¬çš„exeæ–‡ä»¶ï¼ˆé‡å‘½åä»¥åŒºåˆ†ï¼‰
        Copy-Item "dist/BadgePatternTool.exe" $exeName

        echo "=== å‘å¸ƒæ–‡ä»¶åˆ—è¡¨ ==="
        echo "ZIPåŒ…å†…å®¹:"
        Get-ChildItem release/ -Force
        echo "å‘å¸ƒæ–‡ä»¶:"
        Get-ChildItem *.zip, *.exe -Force

        # éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if (Test-Path $zipName) {
          echo "âœ… ZIPæ–‡ä»¶åˆ›å»ºæˆåŠŸ: $zipName"
        } else {
          echo "âŒ ZIPæ–‡ä»¶åˆ›å»ºå¤±è´¥"
          exit 1
        }

        if (Test-Path $exeName) {
          echo "âœ… EXEæ–‡ä»¶åˆ›å»ºæˆåŠŸ: $exeName"
        } else {
          echo "âŒ EXEæ–‡ä»¶åˆ›å»ºå¤±è´¥"
          exit 1
        }

        # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "ZIP_NAME=$zipName" >> $env:GITHUB_ENV
        echo "EXE_NAME=$exeName" >> $env:GITHUB_ENV
        
    - name: Generate release notes
      id: release_notes
      run: |
        $version = "${{ env.VERSION }}"
        $releaseNotes = @"
        # BadgePatternTool $version

        ## ğŸ“¦ ä¸‹è½½é€‰é¡¹

        **æ¨èä¸‹è½½æ–¹å¼**:
        - ğŸ¯ **å•æ–‡ä»¶ç‰ˆ**: `BadgePatternTool-$version.exe` (ç›´æ¥è¿è¡Œï¼Œæ— éœ€è§£å‹)
        - ğŸ“¦ **å®Œæ•´åŒ…**: `BadgePatternTool-$version-Windows.zip` (åŒ…å«è¯´æ˜æ–‡æ¡£)

        **ç³»ç»Ÿè¦æ±‚**: Windows 7/8/10/11 (64ä½)

        ## âœ¨ ä¸»è¦åŠŸèƒ½

        - ğŸ¨ å›¾ç‰‡æ‰¹é‡å¯¼å…¥å’Œåœ†å½¢è£å‰ª
        - âš™ï¸ å¯é…ç½®å¾½ç« å°ºå¯¸ï¼ˆ32mm/58mm/75mmï¼‰
        - ğŸ“ æ™ºèƒ½A4æ’ç‰ˆï¼ˆç½‘æ ¼/ç´§å‡‘æ¨¡å¼ï¼‰
        - ğŸ–¼ï¸ äº¤äº’å¼å›¾ç‰‡ç¼–è¾‘
        - ğŸ“„ å¤šé¡µé¢è‡ªåŠ¨åˆ†é¡µ
        - ğŸ–¨ï¸ é«˜è´¨é‡å¯¼å‡ºå’Œç›´æ¥æ‰“å°

        ## ğŸš€ å¿«é€Ÿå¼€å§‹

        **å•æ–‡ä»¶ç‰ˆ**: ç›´æ¥åŒå‡» `BadgePatternTool-$version.exe` è¿è¡Œ

        **å®Œæ•´åŒ…**:
        1. è§£å‹ `BadgePatternTool-$version-Windows.zip`
        2. åŒå‡»è¿è¡Œ `BadgePatternTool.exe`
        3. æŸ¥çœ‹ `README.md` å’Œ `User_Guide.txt` äº†è§£è¯¦ç»†ä½¿ç”¨æ–¹æ³•

        ## ğŸ“‹ æ›´æ–°å†…å®¹

        æŸ¥çœ‹ [CHANGELOG.md](https://github.com/fenglyu1314/BadgePatternTool/blob/main/CHANGELOG.md) äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚

        ## ğŸ†˜ é—®é¢˜åé¦ˆ

        å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/fenglyu1314/BadgePatternTool/issues) ä¸­åé¦ˆã€‚
        "@
        
        # ä¿å­˜åˆ°æ–‡ä»¶
        $releaseNotes | Out-File -FilePath "release_notes.md" -Encoding UTF8
        
        # è®¾ç½®è¾“å‡º
        echo "RELEASE_NOTES<<EOF" >> $env:GITHUB_ENV
        echo $releaseNotes >> $env:GITHUB_ENV
        echo "EOF" >> $env:GITHUB_ENV
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: BadgePatternTool ${{ env.VERSION }}
        body: ${{ env.RELEASE_NOTES }}
        files: |
          ${{ env.ZIP_NAME }}
          ${{ env.EXE_NAME }}
        draft: false
        prerelease: false
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: BadgePatternTool-${{ env.VERSION }}-artifacts
        path: |
          dist/
          release/
          *.zip
          *.exe
        retention-days: 30
